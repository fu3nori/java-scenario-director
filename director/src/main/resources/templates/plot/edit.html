<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>プロット編集・閲覧</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- CSRF保護 -->
  <!-- CSRF用metaタグ -->
  <meta th:if="${_csrf != null}" name="_csrf"        th:content="${_csrf.token}"       />
  <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />

</head>
<body>
<!-- ヘッダー -->
<div th:replace="fragments/header2 :: header2"></div>

<div class="container mt-4">
  <!-- ロゴ＆見出し -->
  <div class="text-center mb-3">
    <img th:src="@{/img/logo.png}" alt="ロゴ" height="60" />
  </div>
  <h2 class="text-center mb-3">プロット編集・閲覧</h2>

  <!-- 説明文を追加 -->
  <div class="mb-4">
    <p>
      この画面ではシナリオの部品（プロット）の閲覧と編集ができます。<br />
      プロット編集フォームの下にある「追加」ボタンをクリックするとプロットを追加できます。<br />
      フォームの下にある「削除ボタン」をクリックすると該当プロットを削除できます。<br />
      プロット編集フォームをドラッグアンドドロップする事で並び順を変更できます。<br />
      プロットの内容やタイトルはリアルタイム保存されますが明示的に保存したい時は「保存」ボタンをクリックしてください。
    </p>
  </div>


  <!-- プロットタイトル -->
  <div class="mb-4">
    <label for="plotTitle" class="form-label fw-bold">プロットタイトル</label>
    <input id="plotTitle"
           type="text"
           th:value="${plot.title}"
           class="form-control mb-3" />
  </div>

  <!-- プロット行一覧 -->
  <div>
    <label class="form-label fw-bold">プロット編集</label>
    <div id="plotList">
      <div th:each="order, iterStat : ${plotOrders}"
           class="plot-item mb-3"
           th:attr="data-id=${order.id},data-order=${iterStat.index}">
          <textarea class="form-control plot-content"
                    rows="2"
                    th:text="${order.content}"></textarea>
        <button type="button" class="btn btn-primary add-btn me-2 mt-3 mb-1">追加</button>
        <button type="button" class="btn btn-danger delete-btn mt-3 mb-1">削除</button>

      </div>
    </div>
  </div>

  <!-- 保存ボタン -->
  <div class="text-end mb-3">
    <button type="button" class="btn btn-primary rounded-pill" id="saveBtnTop">保存</button>
  </div>
  <div class="text-end mt-4">
    <button type="button" class="btn btn-primary rounded-pill" id="saveBtnBottom">保存</button>
  </div>
</div>

<!-- JSライブラリ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>


<!-- インラインJS -->
<script th:inline="javascript">
  // ==== 共通設定 ====
  const plotId     = [[${plot.id}]];                            // プロットID（数値）
  const csrfToken  = $('meta[name="_csrf"]').attr('content');   // CSRF トークン
  const csrfHeader = $('meta[name="_csrf_header"]').attr('content');

  // すべての Ajax 送信に CSRF ヘッダーを自動セット
  $(document).ajaxSend((e, xhr) => {
    if (csrfHeader && csrfToken) {
      xhr.setRequestHeader(csrfHeader, csrfToken);
    }
  });

  // ==== タイトルのリアルタイム保存（PATCH JSON） ====
  $('#plotTitle').on('input', () => {
    $.ajax({
      url: `/api/plots/${plotId}`,
      method: 'PATCH',
      contentType: 'application/json',
      data: JSON.stringify({ title: $('#plotTitle').val() }),
      success: () => console.log('タイトル保存 OK'),
      error:   xhr => console.error('タイトル保存 NG:', xhr.responseText)
    });
  });

  // ==== 行のドラッグ＆ドロップ有効化 ====
  new Sortable($('#plotList')[0], {
    animation: 150,
    onEnd:     syncAll
  });

  // ==== 行テキスト変更でリアルタイム保存（PATCH JSON） ====
  $(document).on('input', '.plot-content', function() {
    const item    = $(this).closest('.plot-item');
    const id      = item.data('id');
    const content = $(this).val();
    const order   = item.index();
    savePlotOrder(id, content, order);
  });

  function savePlotOrder(id, content, order) {
    $.ajax({
      url: `/api/plot_orders/${id}`,
      method: 'PATCH',
      contentType: 'application/json',
      data: JSON.stringify({ content: content, plotOrder: order }),
      success: () => console.log(`#${id} 更新 OK (order=${order})`),
      error:   xhr => console.error(`#${id} 更新 NG:`, xhr.responseText)
    });
  }

  // ==== 行追加ボタン（POST フォーム送信） ====
  $(document).on('click', '.add-btn', function() {
    const cur   = $(this).closest('.plot-item');
    const index = cur.index() + 1;

    // @RequestParam なので form-data（URL エンコード）で送信
    $.post('/api/plot_orders',
            { plotId: plotId, plotOrder: index },
            function(newItem) {
              // 受け取った JSON を元に行を組み立て
              const html = ''
                      + `<div class="plot-item mb-3" data-id="${newItem.id}">`
                      +   `<textarea class="form-control plot-content" rows="2" style="width:70%;">${newItem.content}</textarea>`
                      +   `<button type="button" class="btn btn-primary add-btn  me-2 mt-3 mb-1">追加</button>`
                      +   `<button type="button" class="btn btn-danger delete-btn  mt-3 mb-1">削除</button>`
                      + `</div>`;
              cur.after(html);
              syncAll();
            },
            'json'
    ).fail(xhr => console.error('追加失敗:', xhr.responseText));
  });

  // ==== 行削除ボタン（DELETE） ====
  $(document).on('click', '.delete-btn', function() {
    const item = $(this).closest('.plot-item');

    // プロットが1つしかない場合は削除禁止
    const totalItems = $('#plotList .plot-item').length;
    if (totalItems <= 1) {
      alert('プロットは最低一つ必要です。');
      return; // 削除中止
    }

    const id = item.data('id');

    $.ajax({
      url: `/api/plot_orders/${id}`,
      method: 'DELETE',
      success: () => {
        item.remove();
        syncAll();
      },
      error: xhr => console.error('削除失敗:', xhr.responseText)
    });
  });


  // ==== 明示保存ボタン ====
  $('#saveBtnTop, #saveBtnBottom').click(syncAll);

  // ==== 全行を一括保存（PATCH JSON） ====
  function syncAll() {
    $('#plotList .plot-item').each(function(i) {
      const id      = $(this).data('id');
      const content = $(this).find('textarea').val();
      savePlotOrder(id, content, i);
    });
  }
</script>


</body>
</html>
