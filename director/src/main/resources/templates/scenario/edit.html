<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>シナリオ編集</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="fragments/header2 :: header"></div>

<div class="container mt-5">
    <div class="text-center mb-4">
        <img src="/img/logo.png" alt="ロゴ">
        <h2>シナリオ編集・閲覧</h2>
    </div>

    <!-- タイトル編集 -->
    <div class="mb-4">
        <label for="title" class="form-label fw-bold">タイトル編集</label>
        <input type="text" id="title" class="form-control" th:value="${scenario.title}">
        <button class="btn btn-primary mt-2" onclick="saveTitle()">保存</button>
    </div>

    <!-- 本文エリア -->
    <div class="mb-4">
        <label class="form-label fw-bold">シナリオ</label>
        <button class="btn btn-secondary mb-2" onclick="saveScenario()">保存</button>

        <!-- 横並びのボタン -->
        <div class="d-flex gap-2 mb-2">
            <a class="btn btn-info" href="#" onclick="saveBeforeExport(); return false;">PDFファイルでエクスポート</a>

            <a class="btn btn-outline-success" href="#" onclick="loadPlot()">プロットを再び出し</a>
        </div>

        <!-- 書式設定バー -->
        <div class="mb-2">
            <select id="styleDropdown" class="form-select form-select-sm w-auto d-inline-block">
                <option value="normal">Normal</option>
                <option value="title">タイトル</option>
                <option value="heading">見出し</option>
            </select>
            <button class="btn btn-sm btn-light" onclick="formatText('bold')"><b>B</b></button>
            <button class="btn btn-sm btn-light" onclick="formatText('strike')"><s>S</s></button>
            <button class="btn btn-sm btn-light" onclick="formatText('underline')"><u>U</u></button>
            <button class="btn btn-sm btn-light" onclick="formatText('italic')"><i>I</i></button>
        </div>

        <!-- シナリオ本文 -->
        <textarea id="body" class="form-control" rows="50" placeholder="ここにシナリオ本文を入力してください…"
                  th:text="${scenario.body}"></textarea>
    </div>
</div>

<!-- IDをJavaScriptに渡す -->
<script th:inline="javascript">
    let scenarioId = [[${scenario.id}]];
</script>

<script>
    function saveTitle() {
        const title = document.getElementById('title').value;
        const body = document.getElementById('body').value;
        fetch('/scenario/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({id: scenarioId, title, body})
        }).then(r => r.text()).then(res => console.log('タイトル保存結果:', res));
    }

    function saveScenario() {
        const body = document.getElementById('body').value;
        const title = document.getElementById('title').value;
        fetch('/scenario/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({id: scenarioId, title, body})
        }).then(r => r.text()).then(res => console.log('シナリオ保存結果:', res));
    }

    // 入力停止後に自動保存（リアルタイム保存）
    let typingTimer;
    const debounceDelay = 1000;
    document.getElementById('body').addEventListener('input', () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(saveScenario, debounceDelay);
    });

    function loadPlot() {
        alert("ここでプロット読み込み処理を書く予定");
    }

    function formatText(type) {
        alert(type + " 機能はまだ未実装です");
    }

    function saveBeforeExport() {
        const title = document.getElementById('title').value;
        const body = document.getElementById('body').value;
        fetch('/scenario/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({id: scenarioId, title, body})
        }).then(() => {
            window.location.href = `/scenario/export/pdf/${scenarioId}`;
        });
    }

    // タイトルのリアルタイム保存
    let titleTimer;
    document.getElementById('title').addEventListener('input', () => {
        clearTimeout(titleTimer);
        titleTimer = setTimeout(saveTitle, debounceDelay);
    });

</script>
</body>
</html>
